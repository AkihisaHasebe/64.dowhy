# 因果グラフ定義書

## 1. 分析目的

- **目的**: 複数の特徴量のうち，変数Yに直接影響を及ぼす因果関係を因果グラフで特定する

## 2. 変数一覧

### Y に因果効果を持つ変数（直接・間接）: 12 変数

| 変数名 | 説明                     | 型         | 役割                             | Y への経路               |
| ------ | ------------------------ | ---------- | -------------------------------- | ------------------------ |
| X      | （例：広告配信有無）     | continuous | 処置変数 (Treatment)             | 直接 (X→Y) + 間接 (X→M→Y, X→M2→Y) |
| Z1     | （例：年齢）             | continuous | 交絡因子 (Confounder)            | 直接 (Z1→Y)             |
| Z2     | （例：性別）             | binary     | 交絡因子 (Confounder)            | 直接 (Z2→Y)             |
| Z3     | （例：地域）             | continuous | 交絡因子 (Confounder, M-Y間)     | 直接 (Z3→Y)             |
| M      | （例：サイト訪問回数）   | continuous | 媒介変数 (Mediator)              | 直接 (M→Y)              |
| M2     | （例：カート追加回数）   | continuous | 媒介変数 (Mediator, 第2経路)     | 直接 (M2→Y)             |
| D1     | （例：季節要因）         | continuous | Y の直接原因                     | 直接 (D1→Y)             |
| IV     | （例：割当乱数）         | binary     | 操作変数 (Instrumental Variable) | 間接 (IV→X→Y)           |
| IV2    | （例：割当乱数2）        | binary     | 操作変数 (Instrumental Variable) | 間接 (IV2→X→Y)          |
| W1     | （例：経済状況）         | continuous | 上流変数 (Z1 の親)               | 間接 (W1→Z1→Y)          |
| W2     | （例：教育水準）         | binary     | 上流変数 (Z2 の親)               | 間接 (W2→Z2→Y)          |
| P1     | （例：UI改善施策）       | continuous | M の親 (Treatment以外)           | 間接 (P1→M→Y)           |

### Y に因果効果を持たないノイズ変数: 7 変数

| 変数名 | 説明                     | 型         | 役割                                     | 擬似相関の有無        |
| ------ | ------------------------ | ---------- | ---------------------------------------- | --------------------- |
| N1     | （例：健康スコア）       | continuous | 擬似相関変数 (Z1 の子)                   | あり (Z1 経由)        |
| N2     | （ノイズ）               | continuous | 無関係変数                               | なし                  |
| N3     | （ノイズ）               | continuous | 無関係変数                               | なし                  |
| N4     | （例：SNS投稿数）        | continuous | 擬似相関変数 (X の子)                    | あり (X 経由)         |
| N5     | （例：ポイント残高）     | continuous | 擬似相関変数 (M の子)                    | あり (M 経由)         |
| N6     | （ノイズ）               | continuous | 無関係変数                               | なし                  |
| N7     | （例：天候指数）         | continuous | 擬似相関変数 (D1 の子)                   | あり (D1 経由)        |

### Y (結果変数)

| 変数名 | 説明                   | 型         | 役割               |
| ------ | ---------------------- | ---------- | ------------------ |
| Y      | （例：購入金額）       | continuous | 結果変数 (Outcome) |

**合計: 20 変数 (因果あり 12 + ノイズ 7 + Y 1)**
**比率: 因果 63% : ノイズ 37% （元の 62.5% : 37.5% を維持）**

### 役割の凡例

- **Treatment**: 介入・処置変数（効果を知りたい原因側）
- **Outcome**: 結果変数（効果を知りたい結果側）
- **Confounder**: 交絡因子（Treatment と Outcome の両方に影響）
- **Mediator**: 媒介変数（Treatment → Mediator → Outcome の経路上）
- **Instrumental Variable**: 操作変数（Treatment にのみ影響し、Outcome には直接影響しない）
- **上流変数**: 交絡因子の親（間接的に Y に影響）
- **擬似相関変数**: Y の原因変数の子（Y との相関はあるが因果効果なし）

## 3. 因果グラフ（DAG）

```
    W1 → Z1 ──→ N1          W2 → Z2
          |\                      / \
          | \                    /   \
          |  v        P1       v     v
          | IV ─→ X ←───── Z3─┐  D1 ──→ N7
          | IV2─↗  |  \       |   |
          |        v   v      v   v
          |        M   M2 → Y ←──┘
          |        |↗       ^
          |     P1─┘       |
          └────────────────┘
```

### エッジ一覧

| From | To  | 根拠・ドメイン知識                                                     |
| ---- | --- | ---------------------------------------------------------------------- |
| W1   | Z1  | 経済状況が年齢層の特性に影響                                           |
| W2   | Z2  | 教育水準が性別による行動差に影響                                       |
| Z1   | X   | 年齢が高いほど広告に接触しやすい                                       |
| Z1   | Y   | 年齢が高いほど購入金額が高い                                           |
| Z2   | X   | 性別により広告配信頻度が異なる                                         |
| Z2   | Y   | 性別により購買行動が異なる                                             |
| Z3   | M   | 地域によりサイト訪問頻度が異なる                                       |
| Z3   | Y   | 地域により購買金額が異なる                                             |
| IV   | X   | ランダム割当により処置が決まる                                         |
| IV2  | X   | 第2のランダム割当により処置が決まる                                     |
| X    | M   | 広告を見るとサイト訪問が増える                                         |
| X    | M2  | 広告を見るとカート追加が増える                                         |
| X    | Y   | 広告が直接購入を促す                                                   |
| M    | Y   | サイト訪問が増えると購入が増える                                       |
| M2   | Y   | カート追加が増えると購入が増える                                       |
| P1   | M   | UI改善施策によりサイト訪問が増える                                     |
| D1   | Y   | 季節要因が購入金額に直接影響                                           |
| Z1   | N1  | 年齢が高いほど健康スコアが高い（Y への直接因果なし → 擬似相関）        |
| X    | N4  | 広告接触によりSNS投稿が増える（Y への因果なし → 擬似相関）            |
| M    | N5  | サイト訪問によりポイント残高が変化（Y への因果なし → 擬似相関）        |
| D1   | N7  | 季節要因が天候に影響（Y への直接因果は D1 経由のみ → N7は擬似相関）    |

### Y の直接原因（真の DAG より）

**X, M, M2, Z1, Z2, Z3, D1** （7変数）

## 4. 仮定の整理

### 識別に必要な仮定

- [ ] **無交絡仮定 (Unconfoundedness)**: 観測された交絡因子で条件付ければ、Treatment の割当は Outcome と独立
- [ ] **正値性 (Positivity)**: すべての交絡因子の値において Treatment を受ける確率が 0 でも 1 でもない
- [ ] **SUTVA (Stable Unit Treatment Value Assumption)**: ある個体の Treatment が他個体の Outcome に影響しない
- [ ] **除外制約 (Exclusion Restriction)**: 操作変数は Treatment を通じてのみ Outcome に影響する（IV, IV2 使用時）

### 含めなかった変数とその理由

| 変数候補     | 除外理由                               |
| ------------ | -------------------------------------- |
| （例：天気） | Outcome への影響が無視できる程度と判断 |

## 5. DoWhy用 グラフ定義コード

```python
import dowhy

# GML形式での因果グラフ定義
causal_graph = """
digraph {
    W1 -> Z1;
    W2 -> Z2;
    Z1 -> X;
    Z1 -> Y;
    Z2 -> X;
    Z2 -> Y;
    Z3 -> M;
    Z3 -> Y;
    IV -> X;
    IV2 -> X;
    X -> M;
    X -> M2;
    X -> Y;
    M -> Y;
    M2 -> Y;
    P1 -> M;
    D1 -> Y;
    Z1 -> N1;
    X -> N4;
    M -> N5;
    D1 -> N7;
}
"""

model = dowhy.CausalModel(
    data=df,
    treatment="X",
    outcome="Y",
    graph=causal_graph,
)
```

## 6. 備考

- この分析の後，すべての因子と，直接因果効果を持つ因子のみ，それぞれのデータセットでRandom Forestによる回帰分析を行い，因果分析による次元削減効果があるかを確かめます．
- 変数数: 9 → 20 に拡張（因果あり 12, ノイズ 7, Y 1）
- 擬似相関変数は 4 種類: Z1経由(N1), X経由(N4), M経由(N5), D1経由(N7)
- 独立ノイズ変数: N2, N3, N6
